{% extends 'layout.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Webhook Management</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWebhookModal">
        <i class="fas fa-plus me-2"></i>Create New Webhook
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Manage Webhooks</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Session</th>
                                <th>URL</th>
                                <th>Events</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="webhooks-table-body">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading webhooks...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">API Endpoints for n8n Integration</h5>
                <span class="badge bg-info">Similar to waha.devlike.pro</span>
            </div>
            <div class="card-body">
                <p class="lead">Use these endpoints in your n8n workflows to send commands to WhatsApp:</p>
                <div class="table-responsive">
                    <table class="table table-hover" id="api-endpoints-table">
                        <thead>
                            <tr>
                                <th>Session</th>
                                <th>Send Text API URL</th>
                                <th>Seen API URL</th>
                                <th>Typing API URL</th>
                                <th>Webhook Receiver URL</th>
                            </tr>
                        </thead>
                        <tbody id="api-endpoints-table-body">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading API endpoints...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <h6>How to use these endpoints:</h6>
                    <div class="accordion" id="endpointExamples">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSendText">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSendText" aria-expanded="false" aria-controls="collapseSendText">
                                    Send Text Example
                                </button>
                            </h2>
                            <div id="collapseSendText" class="accordion-collapse collapse" aria-labelledby="headingSendText" data-bs-parent="#endpointExamples">
                                <div class="accordion-body">
                                    <p>To send a text message, make a POST request with this JSON body:</p>
                                    <pre><code>{
  "chatId": "5511999999999@c.us",
  "message": "Hello from n8n!"
}</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSeen">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeen" aria-expanded="false" aria-controls="collapseSeen">
                                    Mark as Seen Example
                                </button>
                            </h2>
                            <div id="collapseSeen" class="accordion-collapse collapse" aria-labelledby="headingSeen" data-bs-parent="#endpointExamples">
                                <div class="accordion-body">
                                    <p>To mark a chat as seen, make a POST request with this JSON body:</p>
                                    <pre><code>{
  "chatId": "5511999999999@c.us"
}</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTyping">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTyping" aria-expanded="false" aria-controls="collapseTyping">
                                    Start Typing Example
                                </button>
                            </h2>
                            <div id="collapseTyping" class="accordion-collapse collapse" aria-labelledby="headingTyping" data-bs-parent="#endpointExamples">
                                <div class="accordion-body">
                                    <p>To start typing in a chat, make a POST request with this JSON body:</p>
                                    <pre><code>{
  "chatId": "5511999999999@c.us",
  "duration": 3000
}</code></pre>
                                    <p class="text-muted">Note: duration is in milliseconds and is optional (default: 3000ms)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">n8n Webhook Integration</h5>
            </div>
            <div class="card-body">
                <p>Using webhooks, you can connect WhatsApp events to n8n workflows:</p>
                <ol>
                    <li>Create a webhook in n8n with the "Webhook" trigger node</li>
                    <li>Copy the n8n webhook URL</li> 
                    <li>Create a webhook here and paste the n8n URL</li>
                    <li>Select the WhatsApp events you want to trigger the workflow</li>
                </ol>
                <p>Your n8n workflow will receive a JSON payload with WhatsApp event data when the selected events occur.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    For best results, create a separate webhook for each type of automation workflow.
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow">
            <img src="https://images.unsplash.com/photo-1518757632508-b8e0453cc296" class="card-img-top" alt="Webhook concept illustration">
            <div class="card-body">
                <h5 class="card-title">Available Webhook Events</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                message
                                <span class="badge bg-primary rounded-pill">New message</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                message_create
                                <span class="badge bg-primary rounded-pill">Message sent</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                message_ack
                                <span class="badge bg-primary rounded-pill">Read receipt</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                send_text
                                <span class="badge bg-success rounded-pill">Send text API</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                seen
                                <span class="badge bg-success rounded-pill">Message seen</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                typing
                                <span class="badge bg-success rounded-pill">Start typing</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                group_join
                                <span class="badge bg-primary rounded-pill">Group join</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                group_leave
                                <span class="badge bg-primary rounded-pill">Group leave</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                qr
                                <span class="badge bg-primary rounded-pill">QR code</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Webhook Modal -->
<div class="modal fade" id="createWebhookModal" tabindex="-1" aria-labelledby="createWebhookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createWebhookModalLabel">Create New Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-webhook-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="webhook-name" class="form-label">Webhook Name</label>
                            <input type="text" class="form-control" id="webhook-name" required placeholder="Enter a name for this webhook">
                        </div>
                        <div class="col-md-6">
                            <label for="webhook-session" class="form-label">WhatsApp Session</label>
                            <select class="form-select" id="webhook-session" required>
                                <option value="">Select a session</option>
                                <!-- Sessions will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="webhook-url" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="webhook-url" required placeholder="https://n8n.example.com/webhook/...">
                        <div class="form-text">Enter the n8n webhook URL or any other endpoint that will receive the WhatsApp events.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Events to Trigger Webhook</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message" id="event-message" checked>
                                    <label class="form-check-label" for="event-message">
                                        message (Received messages)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message_create" id="event-message-create" checked>
                                    <label class="form-check-label" for="event-message-create">
                                        message_create (Sent messages)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="send_text" id="event-send-text" checked>
                                    <label class="form-check-label" for="event-send-text">
                                        send_text (Send text API)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message_ack" id="event-message-ack" checked>
                                    <label class="form-check-label" for="event-message-ack">
                                        message_ack (Read receipts)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="seen" id="event-seen" checked>
                                    <label class="form-check-label" for="event-seen">
                                        seen (Message seen)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="typing" id="event-typing" checked>
                                    <label class="form-check-label" for="event-typing">
                                        typing (Start typing)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="group_join" id="event-group-join" checked>
                                    <label class="form-check-label" for="event-group-join">
                                        group_join (Group joins)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="group_leave" id="event-group-leave" checked>
                                    <label class="form-check-label" for="event-group-leave">
                                        group_leave (Group leaves)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="qr" id="event-qr">
                                    <label class="form-check-label" for="event-qr">
                                        qr (QR code generated)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="webhook-headers" class="form-label">Custom Headers (Optional)</label>
                        <textarea class="form-control" id="webhook-headers" rows="3" placeholder='{"X-Custom-Header": "Value", "Authorization": "Bearer token"}'></textarea>
                        <div class="form-text">Enter custom headers as a JSON object if needed.</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="webhook-active" checked>
                        <label class="form-check-label" for="webhook-active">Webhook Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-webhook-btn">Create Webhook</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Webhook Modal -->
<div class="modal fade" id="editWebhookModal" tabindex="-1" aria-labelledby="editWebhookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editWebhookModalLabel">Edit Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-webhook-form">
                    <input type="hidden" id="edit-webhook-id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-webhook-name" class="form-label">Webhook Name</label>
                            <input type="text" class="form-control" id="edit-webhook-name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-webhook-session" class="form-label">WhatsApp Session</label>
                            <select class="form-select" id="edit-webhook-session" required>
                                <option value="">Select a session</option>
                                <!-- Sessions will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-webhook-url" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="edit-webhook-url" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Events to Trigger Webhook</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message" id="edit-event-message">
                                    <label class="form-check-label" for="edit-event-message">
                                        message (Received messages)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message_create" id="edit-event-message-create">
                                    <label class="form-check-label" for="edit-event-message-create">
                                        message_create (Sent messages)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="send_text" id="edit-event-send-text">
                                    <label class="form-check-label" for="edit-event-send-text">
                                        send_text (Send text API)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="message_ack" id="edit-event-message-ack">
                                    <label class="form-check-label" for="edit-event-message-ack">
                                        message_ack (Read receipts)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="seen" id="edit-event-seen">
                                    <label class="form-check-label" for="edit-event-seen">
                                        seen (Message seen)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="typing" id="edit-event-typing">
                                    <label class="form-check-label" for="edit-event-typing">
                                        typing (Start typing)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="group_join" id="edit-event-group-join">
                                    <label class="form-check-label" for="edit-event-group-join">
                                        group_join (Group joins)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="group_leave" id="edit-event-group-leave">
                                    <label class="form-check-label" for="edit-event-group-leave">
                                        group_leave (Group leaves)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="qr" id="edit-event-qr">
                                    <label class="form-check-label" for="edit-event-qr">
                                        qr (QR code generated)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-webhook-headers" class="form-label">Custom Headers (Optional)</label>
                        <textarea class="form-control" id="edit-webhook-headers" rows="3"></textarea>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit-webhook-active">
                        <label class="form-check-label" for="edit-webhook-active">Webhook Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="update-webhook-btn">Update Webhook</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="deleteWebhookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this webhook? This action cannot be undone.</p>
                <p><strong>Webhook: </strong><span id="delete-webhook-name"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-webhook-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/webhooks.js') }}"></script>
{% endblock %}
